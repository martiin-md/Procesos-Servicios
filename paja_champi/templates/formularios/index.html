<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Registro de Nuevas Cinas{% endblock %}</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Incluir CSS de Bootstrap Select desde CDN sin integridad -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/css/bootstrap-select.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    body {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    main {
      flex: 1;
    }
    footer {
      background-color: #052B38;
      color: white;
      text-align: center;
    }
    /* Estilo para el marco del formulario */
    .form-container {
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      padding: 15px;
      background-color: #f8f9fa;
      box-shadow: 0 0 0.5rem rgba(0, 0, 0, 0.1);
      margin-top: 10px;
    }
    /* Ajuste para el área de comentarios */
    #comentarios {
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      width: 100%;
      height: 35px;
      font-size: 0.875rem;
    }
    /* Cambiar el color de las etiquetas de los campos de formulario a gris */
    .form-group label {
      color: #6c757d;
    }
    /* Estilo para el botón de enviar formulario */
    .btn-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    .btn-container .btn {
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0.7rem 7rem;
      border-radius: 0.375rem;
    }
    .custom-button {
      background-color: #EE964B;
      border-color: #EE964B;
      color: white;
    }
    .custom-button:hover {
      background-color: #0B5A71;
      border-color: #0B5A71;
      color: white;
    }
    .custom-select {
      background-color: #0D6D8D;
      color: white;
      border-color: #0D6D8D;
    }
    .custom-select:focus {
      border-color: #0B5A71;
      box-shadow: 0 0 0 0.2rem rgba(13, 109, 141, 0.25);
    }
    .flash-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1050;
      width: 400px;
      max-width: 100%;
      background-color: #59CD90;
      color: white;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .flash-overlay.show {
      display: block;
      opacity: 0.8;
    }
    .flash-overlay.hide {
      opacity: 0;
    } 
    .btn-custom {
      background-color: #0D6D8D; 
      color: #FFFFFF;            
      border-color: #0D6D8D;      
    }
    .btn-custom:hover, .btn-custom:focus {
      background-color: #0B5A71;  
      border-color: #0B5A71;
      color: #FFFFFF;
    }
    .btn-custom .filter-option-inner-inner {
      color: #FFFFFF; 
    }
    .bootstrap-select .dropdown-menu li a {
      color:rgb(0, 0, 0); 
    }    
    
    /* Cambia el fondo y el color de texto del menú desplegable */
    .bootstrap-select .dropdown-menu {
      background-color: #FFFFFF; 
    }
  </style>
</head>
{% include 'header.html' %}
<body>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash-overlay show" role="alert">
      {{ messages[0] }}
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const flashOverlay = document.querySelector('.flash-overlay');
        flashOverlay.classList.add('show');
        setTimeout(function() {
          flashOverlay.classList.add('hide');
        }, 3000);
        setTimeout(function() {
          flashOverlay.style.display = 'none';
        }, 3500);
      });
    </script>
  {% endif %}
  {% endwith %}

  <!-- Se asigna un id al formulario para capturar el evento submit -->
  <main class="container my-8" style="margin-top: 125px;">
    <div class="form-container">
      <form id="formulario" method="POST" action="/index">
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label for="contrato_marco">Contrato Marco</label>
              <input type="text" class="form-control" id="contrato_marco" name="contrato_marco" required oninput="generarCodigoCINA()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="fecha_acuerdo">Fecha de Acuerdo</label>
              <input type="date" class="form-control" id="fecha_acuerdo" name="fecha_acuerdo" required>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="anio_cosecha">Año de Cosecha</label>
              <select class="form-control custom-select" id="anio_cosecha" name="anio_cosecha" required onchange="generarCodigoCINA()">
              </select>
            </div>
          </div>
        </div>
                
        <div class="row">
          <div class="col-md">
            <div class="form-group">
              <label for="codigo_cina">Código CINA</label>
              <input type="text" class="form-control" id="codigo_cina" name="codigo_cina" readonly>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <label for="proveedor">Proveedor</label>
              <div class="input-group">
                <!-- Se usa solo la clase selectpicker, se mantiene el estilo con data-style -->
                <select class="selectpicker" data-width="913px" data-style="btn-custom" data-live-search="true" data-live-search-placeholder="Buscar..." id="proveedor" name="proveedor" required onchange="generarCodigoCINA()">
                  <option value="">Seleccionar...</option>
                  {% for id, nombreProveedor in proveedores %}
                    <option value="{{ id }}">{{ nombreProveedor }}</option>
                  {% endfor %}
                </select>
                <div class="input-group-append">
                  <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#crearProveedorModal">
                    + Nuevo proveedor
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label for="paraje">Paraje</label>
              <input type="text" class="form-control" id="paraje" name="paraje" required oninput="generarCodigoCINA()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="localidad">Localidad</label>
              <input type="text" class="form-control" id="localidad" name="localidad" required>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="coordenadas">Coordenadas</label>
              <input type="text" class="form-control" id="coordenadas" name="coordenadas" required>
            </div>
          </div>
        </div>
        <div class="row">
          <!-- Campo Kilos: tipo text para permitir formateo en tiempo real -->
          <div class="col-md-3">
            <div class="form-group">
              <label for="kilos">Kilos</label>
              <input type="text" class="form-control" id="kilos" name="kilos" required oninput="formatKilos(this); calcularKilosPaquete()">
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="num_paquetes">Nº Paquetes</label>
              <input type="text" class="form-control" id="num_paquetes" name="num_paquetes" required oninput="formatPaquetes(this); calcularKilosPaquete()">
            </div>
          </div>
          <!-- Campo Kilos por Paquete: se muestra el resultado formateado -->
          <div class="col-md-3">
            <div class="form-group">
              <label for="kilos_paquete">Kilos por Paquete</label>
              <input type="text" class="form-control" id="kilos_paquete" name="kilos_paquete" readonly>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="precio_tonelada">Precio por Tonelada</label>
              <input type="number" class="form-control" id="precio_tonelada" name="precio_tonelada" step="0.01" required>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-3">
            <div class="form-group">
              <label for="tipo_paja_riego">Tipo de Paja según Riego</label>
              <select class="form-control custom-select" id="tipo_paja_riego" name="tipo_paja_riego" required>
                <option value="">Seleccionar...</option>
                <option value="secano">SECANO</option>
                <option value="regadío">REGADÍO</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="tipo_paja_cereal">Tipo de Paja según Cereal</label>
              <select class="form-control custom-select" id="tipo_paja_cereal" name="tipo_paja_cereal" required onchange="generarCodigoCINA()">
                <option value="">Seleccionar...</option>
                {% for id, cereal in cereales %}
                  <option value="{{ id }}">{{ cereal }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="tipo_calidad">Tipo según Calidad</label>
              <select class="form-control custom-select" id="tipo_calidad" name="tipo_calidad" required>
                <option value="">Seleccionar...</option>
                <option value="tapas">TAPAS</option>
                <option value="cinas">CINAS</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="planta_destino">Planta Destino</label>
              <select class="form-control custom-select" id="planta_destino" name="planta_destino" required>
                <option value="">Seleccionar...</option>
                <option value="PCHAMPI">PCHAMPI</option>
                <option value="PSETAS">PSETAS</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="comentarios">Comentarios</label>
          <textarea class="form-control" id="comentarios" name="comentarios" rows="6" placeholder="Ingrese sus comentarios aquí"></textarea>
        </div>

        <div class="btn-container">
          <button type="submit" class="btn custom-button">ENVIAR FORMULARIO</button>
        </div>
      </form>
    </div>
    <!-- Modal para crear nuevo proveedor -->
    <div class="modal fade" id="crearProveedorModal" tabindex="-1" role="dialog" aria-labelledby="crearProveedorModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form action="{{ url_for('crear_proveedor') }}" method="post">
            <div class="modal-header">
              <h5 class="modal-title" id="crearProveedorModalLabel">Crear nuevo proveedor</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="nombreProveedor">Nombre del proveedor</label>
                <input type="text" name="nombreProveedor" id="nombreProveedor" class="form-control" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Agregar proveedor</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-3">
    <p></p>
  </footer>

  <!-- Cargar jQuery y Bootstrap Bundle -->
  <script src="/static/js/jquery-3.5.1.min.js"></script>
  <script src="/static/js/4.5.2.bootstrap.bundle.min.js"></script>
  <!-- Incluir JS de Bootstrap Select desde CDN sin integridad -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>
  <script>
    $(document).ready(function(){
      $('.selectpicker').selectpicker();
    });
    // Generar el código CINA dinámicamente
    function generarCodigoCINA() {
      var contrato_marco = document.getElementById('contrato_marco').value;
      var paraje = document.getElementById('paraje').value;
      var anio_cosecha = document.getElementById('anio_cosecha').value;
  
      var proveedorSelect = document.getElementById('proveedor');
      var proveedor = proveedorSelect.options[proveedorSelect.selectedIndex].value;
      proveedor = proveedor === "" ? "" : proveedorSelect.options[proveedorSelect.selectedIndex].text;
  
      var tipoPajaCerealSelect = document.getElementById('tipo_paja_cereal');
      var tipo_paja_cereal = tipoPajaCerealSelect.options[tipoPajaCerealSelect.selectedIndex].value;
      tipo_paja_cereal = tipo_paja_cereal === "" ? "" : tipoPajaCerealSelect.options[tipoPajaCerealSelect.selectedIndex].text;
  
      var codigoCINA = contrato_marco + '/' + anio_cosecha + '/' + proveedor + '/' + paraje + '/' + tipo_paja_cereal;
      document.getElementById('codigo_cina').value = codigoCINA;
    }
  
    // Función para formatear el valor de "Kilos" directamente en el input
    function formatKilos(input) {
      let value = input.value.replace(/[^0-9,]/g, '');
      let parts = value.split(',');
      if (parts.length > 1) {
        value = parts[0] + ',' + parts[1].replace(/,/g, '');
      }
      let rawValue = value.replace(/\./g, '').replace(',', '.');
      let number = parseFloat(rawValue);
      if (!isNaN(number)) {
        let decimalDigits = (value.indexOf(',') !== -1) ? parts[1].length : 0;
        let formatted = number.toLocaleString('es-ES', {
          minimumFractionDigits: decimalDigits,
          maximumFractionDigits: decimalDigits
        });
        input.value = formatted;
      }
    }
  
    // Función para calcular y formatear "Kilos por Paquete"
    function calcularKilosPaquete() {
      var kilosStr = document.getElementById('kilos').value;
      kilosStr = kilosStr.replace(/\./g, '').replace(',', '.');
      var kilos = parseFloat(kilosStr) || 0;
      var num_paquetes = parseFloat(document.getElementById('num_paquetes').value.replace(/\./g, '')) || 0;
      var valor = num_paquetes > 0 ? (kilos / num_paquetes) : 0;
      var formatted = valor.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('kilos_paquete').value = formatted;
    }
  
    // Establecer el rango de años para el desplegable de año de cosecha
    function ajustarAnioCosecha() {
      var anioActual = new Date().getFullYear();
      var selectAnioCosecha = document.getElementById('anio_cosecha');
      var html = '';
      for (var anio = 2020; anio <= anioActual; anio++) {
        html += '<option value="' + anio + '">' + anio + '</option>';
      }
      selectAnioCosecha.innerHTML = html;
    }
  
    // Antes de enviar el formulario, limpiar los valores formateados
    document.getElementById("formulario").addEventListener("submit", function(e) {
      var kilosInput = document.getElementById('kilos');
      var cleanedKilos = kilosInput.value.replace(/\./g, '').replace(',', '.');
      kilosInput.value = cleanedKilos;
  
      var kilosPaqueteInput = document.getElementById('kilos_paquete');
      var cleanedKilosPaquete = kilosPaqueteInput.value.replace(/\./g, '').replace(',', '.');
      kilosPaqueteInput.value = cleanedKilosPaquete;
      
      var numPaquetesInput = document.getElementById('num_paquetes');
      numPaquetesInput.value = numPaquetesInput.value.replace(/\./g, '');
    });
  
    // Función para formatear el número de paquetes con separador de miles (punto)
    function formatPaquetes(input) {
      let value = input.value.replace(/\D/g, '');
      if (value === '') {
        input.value = '';
        return;
      }
      let number = parseInt(value, 10);
      let formatted = number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      input.value = formatted;
    }
  
    window.onload = ajustarAnioCosecha;
  </script>
</body>
</html>

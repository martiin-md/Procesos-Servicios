<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Producción{% endblock %}</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Select2 CSS -->
  <link rel="stylesheet" href="/static/css/select2.min.css">
  <style>
      .page-title {
        font-size: 2rem;
        font-weight: bold;
        color: #052B38;
        text-align: center;
        margin-bottom: 20px;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
      }
      html, body {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
      }
      body {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .form-group {
        display: block;
      }
      main {
        flex: 1;
      }
      footer {
        background-color: #052B38;
        color: white;
        text-align: center;
      }
      .form-container {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 15px;
        background-color: #f8f9fa;
        box-shadow: 0 0 0.5rem rgba(0, 0, 0, 0.1);
        margin-top: 10px;
      }
      .btn-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        margin-bottom: 10px;
      }
      .btn-container .btn {
        font-weight: bold;
        font-size: 0.9rem;
        padding: 0.7rem 7rem;
        border-radius: 0.375rem;
      }
      .custom-button {
        background-color: #EE964B;
        border-color: #EE964B;
        color: white;
      }
      .custom-button:hover {
        background-color: #0B5A71;
        border-color: #0B5A71;
        color: white;
      }
      .custom-select {
        background-color: #0D6D8D;
        color: white;
        border-color: #0D6D8D;
      }
      .custom-select:focus {
        border-color: #0B5A71;
        box-shadow: 0 0 0 0.2rem rgba(13, 109, 141, 0.25);
      }
      .flash-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        width: 400px;
        max-width: 100%;
        background-color: #59CD90;
        color: white;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
      .flash-overlay.show {
        display: block;
        opacity: 0.8;
      }
      .flash-overlay.hide {
        opacity: 0;
      }
      /* Ajuste para el área de observaciones */
      #observaciones {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        width: 100%;
        height: 35px;
        font-size: 0.875rem;
      }
      /* Estilo general del select */
      .select2-container--default .select2-selection--single {
        background-color: #0D6D8D;
        border: 1px solid #0D6D8D;
        border-radius: 0.25rem;
        color: white;
        font-size: 0.875rem;
        height: 35px;
        padding: 0 12px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: white;
      }
      .select2-container--default .select2-results__option {
        background-color: white;
        color: #0D6D8D;
      }
      .select2-container--default .select2-results__option:hover {
        background-color: #0D6D8D;
        color: white;
      }
      .select2-container--default .select2-results__option--selected {
        background-color: white;
        color: #0D6D8D;
      }
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: white;
      }
      .select2-container--default .select2-dropdown {
        min-width: 100%;
      }
      .custom-dropdown .select2-results {
        min-width: 200px;
      }
  </style>
</head>
{% include 'header.html' %}
<body>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash-overlay show" role="alert">
      {{ messages[0] }}
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const flashOverlay = document.querySelector('.flash-overlay');
        flashOverlay.classList.add('show');
        setTimeout(function() {
          flashOverlay.classList.add('hide');
        }, 3000);
        setTimeout(function() {
          flashOverlay.style.display = 'none';
        }, 3500);
      });
    </script>
  {% endif %}
  {% endwith %}

  <main class="container my-8" style="margin-top: 200px;">
    <h1 class="page-title">REGISTRO OPERACIONES</h1>
    <div class="form-container">
      <form method="POST" action="/produccion">
        <!-- Fila 1: Tipo de Stock, Fecha y cantidad a mover -->
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label for="tipo_stock">Tipo de Stock</label>
              <select class="form-control custom-select" id="tipo_stock" name="tipo_stock" required>
                <option value="">Seleccionar...</option>
                <option value="PCHAMPI">PCHAMPI</option>
                <option value="PSETAS">PSETAS</option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label for="fecha">Fecha</label>
              <input type="datetime-local" class="form-control" id="fecha" name="fecha" value="{{ fecha_actual }}" required>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="kg_mover">Kilos</label>
              <input type="text" class="form-control" id="kg_mover" name="kg_mover" required oninput="formatKilos(this)">
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="paquetes_mover">Paquetes</label>
              <!-- Se cambia el tipo a "text" y se agrega oninput para formatear -->
              <input type="text" class="form-control" id="paquetes_mover" name="paquetes_mover" required oninput="formatPaquetes(this)">
            </div>
          </div>
        </div>

        <!-- Fila 2: Selección de Origen y Nº OP -->
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="origen_stock">Origen (Ubicación)</label>
              <select class="form-control custom-select" id="origen_stock" name="origen_stock" required>
                <option value="">Seleccionar origen...</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="num_op">Nº OP</label>
              <input type="text" class="form-control" id="num_op" name="num_op" required>
            </div>
          </div>
        </div>

        <!-- Campo de Observaciones -->
        <div class="form-group">
          <label for="observaciones">Observaciones</label>
          <textarea class="form-control" id="observaciones" name="observaciones" rows="3" placeholder="Ingrese sus observaciones aquí"></textarea>
        </div>

        <div class="btn-container">
          <button type="submit" class="btn custom-button">REALIZAR MOVIMIENTO</button>
        </div>
      </form>
    </div>
  </main>

  <!-- Contenedores ocultos con las opciones para cada tipo de stock -->
  <div id="opciones_setas" style="display: none;">
    <option value="">Seleccionar origen de setas...</option>
    {% for origen in stock_setas %}
      <option value="{{ origen[0] }}">{{ origen[1] }} ({{ origen[2]|format_number }} kg, {{ origen[3] }} p)</option>
    {% endfor %}
  </div>

  <div id="opciones_champis" style="display: none;">
    <option value="">Seleccionar origen de champiñones...</option>
    {% for origen in stock_champis %}
      <option value="{{ origen[0] }}">{{ origen[1] }} ({{ origen[2]|format_number }} kg, {{ origen[3] }} p)</option>
    {% endfor %}
  </div>

  <!-- Include jQuery y Select2 -->
  <script src="/static/js/jquery-3.5.1.min.js"></script>
  <script src="/static/js/select2.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      $('#tipo_stock').select2({
        placeholder: 'Seleccionar...',
        width: '100%',
        dropdownAutoWidth: true,
        dropdownCssClass: 'custom-dropdown'
      });

      $('#origen_stock').select2({
        placeholder: 'Seleccionar...',
        width: '100%',
        dropdownAutoWidth: true,
        dropdownCssClass: 'custom-dropdown'
      });

      $('#tipo_stock').on('change', function() {
        var tipoStock = $(this).val();
        console.log("Tipo de Stock seleccionado:", tipoStock);
        if (tipoStock === 'PCHAMPI') {
          var opciones = $('#opciones_champis').html();
          $('#origen_stock').html(opciones);
        } else if (tipoStock === 'PSETAS') {
          var opciones = $('#opciones_setas').html();
          $('#origen_stock').html(opciones);
        } else {
          $('#origen_stock').html('<option value="">Seleccionar origen...</option>');
        }
      });
    });

    // Función para formatear "Kilos" al estilo europeo (ej. 1.234,56)
    function formatKilos(input) {
      let value = input.value.replace(/[^0-9,]/g, '');
      let parts = value.split(',');
      if (parts.length > 1) {
        value = parts[0] + ',' + parts[1].replace(/,/g, '');
      }
      let rawValue = value.replace(/\./g, '').replace(',', '.');
      let number = parseFloat(rawValue);
      if (!isNaN(number)) {
        let decimalDigits = (value.indexOf(',') !== -1) ? parts[1].length : 0;
        let formatted = number.toLocaleString('es-ES', {
          minimumFractionDigits: decimalDigits,
          maximumFractionDigits: decimalDigits
        });
        input.value = formatted;
      }
    }

    // Función para formatear "Paquetes" (números enteros con separador de miles usando punto)
    function formatPaquetes(input) {
      let value = input.value.replace(/\D/g, '');
      if (value === '') {
        input.value = '';
        return;
      }
      let number = parseInt(value, 10);
      let formatted = number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      input.value = formatted;
    }

    // Exponer funciones para que sean accesibles desde atributos inline (si fuera necesario)
    window.formatKilos = formatKilos;
    window.formatPaquetes = formatPaquetes;

    // Limpiar el valor formateado antes de enviar el formulario
    document.querySelector("form").addEventListener("submit", function(e) {
      var kgMoverInput = document.getElementById('kg_mover');
      var cleanedKgMover = kgMoverInput.value.replace(/\./g, '').replace(',', '.');
      kgMoverInput.value = cleanedKgMover;

      var paquetesMoverInput = document.getElementById('paquetes_mover');
      var cleanedPaquetesMover = paquetesMoverInput.value.replace(/\./g, '');
      paquetesMoverInput.value = cleanedPaquetesMover;
    });
  </script>

  <footer class="py-3">
    <p></p>
  </footer>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}Stock de Cinas{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    body {
      flex: 1;
    }
    main {
      flex: 1;
      margin-top: 120px;
    }
    footer {
      background-color: #052B38;
      color: white;
      text-align: center;
      padding: 1rem;
    }
    .page-title {
      font-size: 2rem;
      font-weight: bold;
      color: #052B38;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
      margin: 0;
    }
    /* Contenedor para la cabecera */
    .header-group {
      display: flex;
      align-items: center;
      justify-content: center; /* Centra horizontalmente */
      flex-wrap: wrap;         /* Permite que se ajuste si la pantalla es pequeña */
      gap: 1rem;               /* Espacio entre elementos */
      margin-bottom: 20px;
    }
    /* Grupo de botones de filtros */
    .btn-group {
      display: flex;
    }
    /* Tabla y estilos */
    .table td, .table th {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      padding: 0.4rem;
    }
    .table-responsive {
      margin-top: 20px;
    }
    .progress-custom {
      position: relative;
      width: 100%;
      height: 25px;
      border: 1px solid #333;
      border-radius: 0.25rem;
      background-color: #e9ecef;
      overflow: hidden;
      margin-bottom: 0;
    }
    .progress-bar {
      transition: width 0.6s ease;
    }
    .progress-label {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
      font-weight: bold;
      pointer-events: none;
    }
    table.table {
      width: auto;
      table-layout: auto;
    }
    #stockTable th:nth-child(6),
    #stockTable td:nth-child(6) {
      min-width: 100px;
    }
    .mi-barra {
      background-color: #EE964B;
    }
    /* Imagen y marcadores */
    .image-container {
      position: relative;
      display: inline-block;
    }
    .marker {
      position: absolute;
      width: 15px;
      height: 15px;
      background-color: red;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
    }
    .marker.active {
      border-color: yellow;
      box-shadow: 0 0 10px 3px rgba(255, 255, 0, 0.8);
      transform: scale(1.4);
      z-index: 999; 
    }
    tr.highlight {
      background-color: yellow;
    }
    /* Botones de filtros (activos e inactivos) */
    .btn-primary {
      background-color: #EE964B !important;
      border-color: #EE964B !important;
    }
    .btn-primary:hover,
    .btn-primary:focus {
      background-color: #EE964B !important;
      border-color: #EE964B !important;
    }
    .btn-secondary {
      background-color: #f8f9fa !important;
      border-color: #ced4da !important;
      color: #495057 !important;
    }
    .btn-new-cina {
      background-color: #0D6D8D !important;
      border-color: #0D6D8D !important;
      color: white !important;
    }
    .btn-new-cina:hover{
      background-color: #0B5A71 !important;
      border-color: #0B5A71 !important;
    }

    .btn:focus, .btn:active, .btn:hover {
      outline: none !important;
      box-shadow: none !important;
    }
    @media (min-width: 768px) {
      .col-md-45 {
        flex: 0 0 47%;
        max-width: 60%;
      }
    }
  </style>
</head>
<body>
  {% include 'header.html' %}

  <main class="container-fluid">
    <!-- Cabecera: Título + botones de filtro + botón "Crear Nueva CINA" en una sola fila -->
    <div class="header-group">
      <h1 class="page-title">STOCK CINAS</h1>

      <!-- Botones de filtro (Champiñones y Setas) -->
      <div class="btn-group">
        <button id="btnChamp" class="btn btn-primary" onclick="filterStock('champiñones')">Champiñones</button>
        <button id="btnSetas" class="btn btn-secondary" onclick="filterStock('setas')">Setas</button>
      </div>

      <!-- Botón Crear Nueva CINA con un margen extra a la izquierda para diferenciarlo -->
      <button type="button" class="btn btn-new-cina ml-3" data-toggle="modal" data-target="#crearCinaModal">
        Nueva cina
      </button>
    </div>

    <!-- Modal para crear nueva CINA -->
    <div class="modal fade" id="crearCinaModal" tabindex="-1" role="dialog" aria-labelledby="crearCinaModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form action="{{ url_for('crear_cina') }}" method="post">
            <div class="modal-header">
              <h5 class="modal-title" id="crearCinaModalLabel">Crear nueva CINA</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!-- Seleccionar tipo de CINA -->
              <div class="form-group">
                <label for="cinaType">Tipo de CINA</label>
                <select name="cinaType" id="cinaType" class="form-control" required>
                  <option value="setas">Setas</option>
                  <option value="champiñones">Champiñones</option>
                </select>
              </div>
              <!-- Nombre del destino -->
              <div class="form-group">
                <label for="destinoNombre">Nombre de la CINA</label>
                <input type="text" name="destinoNombre" id="destinoNombre" class="form-control" required>
              </div>
              <!-- Kilos y Paquetes se insertan a 0 por defecto en el backend -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Crear CINA</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- CONTENIDO PRINCIPAL: Imagen + tabla de stock -->
    <div class="row" style="min-height: 60vh;">
      <!-- Columna de la imagen -->
      <div class="col-md-45 offset-md-1 d-flex align-items-center justify-content-center">
        <div class="image-container">
          <img src="/static/images/champinter_champiñon.jpeg" alt="Champinter Champiñón" style="width: 800px; height: auto;">
          <!-- Marcadores sobre la imagen -->
          <div class="marker" data-id="1" style="left: 45.75%; top: 83.80%;"></div>
          <div class="marker" data-id="2" style="left: 30.63%; top: 82.07%;"></div>
          <div class="marker" data-id="3" style="left: 53.75%; top: 76.92%;"></div>
          <div class="marker" data-id="4" style="left: 36.63%; top: 83.49%;"></div>
          <div class="marker" data-id="5" style="left: 64.75%; top: 16.90%;"></div>
          <div class="marker" data-id="6" style="left: 47.63%; top: 67.68%;"></div>
          <div class="marker" data-id="7" style="top: 32%; left: 30%;"></div>
          <div class="marker" data-id="8" style="top: 34%; left: 60%;"></div>
          <div class="marker" data-id="9" style="top: 36%; left: 30%;"></div>
          <div class="marker" data-id="10" style="top: 38%; left: 60%;"></div>
          <div class="marker" data-id="11" style="top: 40%; left: 60%;"></div>
          <div class="marker" data-id="12" style="top: 42%; left: 30%;"></div>
          <div class="marker" data-id="13" style="top: 44%; left: 60%;"></div>
          <div class="marker" data-id="14" style="top: 46%; left: 30%;"></div>
          <div class="marker" data-id="15" style="top: 48%; left: 60%;"></div>
        </div>
      </div>
      <!-- Columna de la tabla -->
      <div class="col-md-5 d-flex align-items-center justify-content-center">
        <div class="table-responsive" style="margin-left: 20px;">
          <table class="table" id="stockTable">
            <thead>
              <tr>
                <th>ID Stock</th>
                <th>Destino</th>
                <th>Kilos</th>
                <th>Paquetes</th>
                <th>Kilos/Paquete</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for item in stock %}
              <tr data-id="{{ item.id_stock }}" data-tipo="{{ item.tipo|lower }}" {% if item.tipo != 'Champiñones' %}style="display: none;"{% endif %}>
                <td>{{ item.id_stock }}</td>
                <td>
                  {% if item.destino != 'N/A' %}
                    <a href="{{ url_for('detalle_cina', tipo=item.tipo|lower, destino=item.destino) }}">{{ item.destino }}</a>
                  {% else %}
                    {{ item.destino }}
                  {% endif %}
                </td>
                <td>{{ item.kilos|euroformat }}</td>
                <td>{{ item.paquetes|euroformat }}</td>
                <td>
                  {% if item.kilos_por_paquete is not none %}
                    {{ item.kilos_por_paquete|euroformat }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  <div class="progress progress-custom">
                    <div class="progress-bar progress-bar-striped progress-bar-animated mi-barra"
                         role="progressbar"
                         style="width: {{ (item.kilos / max_kilos * 100) if max_kilos > 0 else 0 }}%;"></div>
                    <span class="progress-label">
                      {{ item.kilos|euroformat }} kg
                    </span>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div> 
      </div> 
    </div> 
  </main>

  <footer>
    <p></p>
  </footer>

  <!-- jQuery y Bootstrap JS -->
  <script src="/static/js/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  
  <script>
    function filterStock(tipo) {
      var rows = document.querySelectorAll("#stockTable tbody tr");
      rows.forEach(function(row) {
        var rowTipo = row.getAttribute("data-tipo");
        if (rowTipo === tipo) {
          row.style.display = "table-row";
        } else {
          row.style.display = "none";
        }
      });
      var btnChamp = document.getElementById("btnChamp");
      var btnSetas = document.getElementById("btnSetas");
      btnChamp.classList.remove("btn-primary");
      btnChamp.classList.add("btn-secondary");
      btnSetas.classList.remove("btn-primary");
      btnSetas.classList.add("btn-secondary");
      if (tipo === "champiñones") {
        btnChamp.classList.remove("btn-secondary");
        btnChamp.classList.add("btn-primary");
      } else {
        btnSetas.classList.remove("btn-secondary");
        btnSetas.classList.add("btn-primary");
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      filterStock("champiñones");
  
      // ------- Evento en Marcadores: marcar la fila en la tabla -------
      document.querySelectorAll('.marker').forEach(function(marker) {
        marker.addEventListener('click', function(){
          var markerId = this.getAttribute('data-id');
  
          // Desactivar todos los marcadores
          document.querySelectorAll('.marker').forEach(function(m){
            m.classList.remove('active');
          });
          this.classList.add('active');
  
          // Resaltar la fila correspondiente en la tabla
          var row = document.querySelector('tr[data-id="' + markerId + '"]');
          if (row) {
            document.querySelectorAll('#stockTable tbody tr').forEach(function(r){
              r.classList.remove('highlight');
            });
            row.classList.add('highlight');
            row.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        });
      });
  
      // ------- Evento en filas de la tabla: marcar el punto del mapa -------
      var tableRows = document.querySelectorAll("#stockTable tbody tr");
      tableRows.forEach(function(row) {
        row.addEventListener("click", function(){
          var rowId = row.getAttribute('data-id');
          tableRows.forEach(function(r){
            r.classList.remove('highlight');
          });
          row.classList.add('highlight');
          var allMarkers = document.querySelectorAll('.marker');
          allMarkers.forEach(function(m){
            m.classList.remove('active');
          });
          var marker = document.querySelector('.marker[data-id="' + rowId + '"]');
          if (marker) {
            marker.classList.add('active');
          }
        });
      });
    });
  </script>
</body>
</html>

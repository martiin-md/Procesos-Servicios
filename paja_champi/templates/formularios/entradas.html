<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Registro de Entradas CINA{% endblock %}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Select2 CSS -->
    <link rel="stylesheet" href="/static/css/select2.min.css">
    <style>
        .page-title {
            font-size: 2rem;
            font-weight: bold;
            color: #052B38;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        body {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        /* Mostrar los campos cuando sean necesarios */
        .form-group {
            display: block;
        }
        main {
            flex: 1;
        }
        
        .header-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
        }
        footer {
            background-color: #052B38;
            color: white;
            text-align: center;
        }
        .form-container {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 15px;
            background-color: #f8f9fa;
            box-shadow: 0 0 0.5rem rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }
        .btn-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .btn-container .btn {
            font-weight: bold;
            font-size: 0.9rem;
            padding: 0.7rem 7rem;
            border-radius: 0.375rem;
        }
        .custom-button {
            background-color: #EE964B;
            border-color: #EE964B;
            color: white;
        }
        .custom-button:hover {
            background-color: #0B5A71;
            border-color: #0B5A71;
            color: white;
        }
        .custom-select {
            background-color: #0D6D8D;
            color: white;
            border-color: #0D6D8D;
        }
        .custom-select:focus {
            border-color: #0B5A71;
            box-shadow: 0 0 0 0.2rem rgba(13, 109, 141, 0.25);
        }
        .flash-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
            width: 400px;
            max-width: 100%;
            background-color: #59CD90;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .flash-overlay.show {
            display: block;
            opacity: 0.8;
        }
        .flash-overlay.hide {
            opacity: 0;
        }
        /* Ajuste para el área de observaciones */
        #observaciones {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            width: 100%;
            height: 35px;
            font-size: 0.875rem;
        }
        /* Estilo general del select */
        .select2-container--default .select2-selection--single {
            background-color: #0D6D8D;
            border: 1px solid #0D6D8D;
            border-radius: 0.25rem;
            color: white;
            font-size: 0.875rem;
            height: 35px;
            padding: 0 12px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: white;
        }
        .select2-container--default .select2-results__option {
            background-color: white;
            color: #0D6D8D;
        }
        .select2-container--default .select2-results__option:hover {
            background-color: #0D6D8D;
            color: white;
        }
        .select2-container--default .select2-results__option--selected {
            background-color: white;
            color: #0D6D8D;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: white;
        }
        .select2-container--default .select2-dropdown {
            min-width: 100%;
        }
        .custom-dropdown .select2-results {
            min-width: 200px;
        }
    </style>
</head>
{% include 'header.html' %}
<body>
    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="flash-overlay show" role="alert">
            {{ messages[0] }}
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const flashOverlay = document.querySelector('.flash-overlay');
                flashOverlay.classList.add('show');
                setTimeout(function() {
                    flashOverlay.classList.add('hide');
                }, 3000);
                setTimeout(function() {
                    flashOverlay.style.display = 'none';
                }, 3500);
            });
        </script>
    {% endif %}
    {% endwith %}

    <main class="container my-8" style="margin-top: 200px;">
        <div class="header-container">
            <h2 class="page-title">REGISTRAR ENTRADAS</h2>
            <div class="d-flex align-items-center mb-3">
            <!-- Enlace a Historial de Entradas -->
            <a href="{{ url_for('historial_entradas') }}" class="btn custom-button mr-2">Historial</a>
            </div>
        </div>
 
        <div class="form-container">
            <form method="POST" action="/entradas">
                <!-- Primera fila: Código CINA, Fecha y Kilos de Entrada -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="codigo_cina">Código CINA</label>
                            <select class="form-control custom-select" id="codigo_cina" name="codigo_cina" required>
                                <option value="">Seleccionar...</option>
                                {% for cina in cinas %}
                                <option value="{{ cina[0] }}">{{ cina[0] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="fecha">Fecha</label>
                            <input type="datetime-local" class="form-control" id="fecha" name="fecha" value="{{ fecha_actual }}" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="kg_entrada">Kilos de Entrada</label>
                            <input type="text" class="form-control" id="kg_entrada" name="kg_entrada" required oninput="formatKilos(this)">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="kg_descuento">Kg de Descuento</label>
                            <input type="text" class="form-control" id="kg_descuento" name="kg_descuento" required oninput="formatKilos(this)">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="n_paquetes">Número de Paquetes</label>
                            <input type="text" class="form-control" id="n_paquetes" name="n_paquetes" required oninput="formatPaquetes(this)">
                        </div>
                    </div>
                </div>

                <!-- Campo único para el Destino -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="destino">Destino</label>
                            <select class="form-control custom-select" id="destino" name="destino">
                                <option value="">Seleccionar destino...</option>
                            </select>
                            <!-- Campo oculto para almacenar el tipo de destino -->
                            <input type="hidden" name="destino_tipo" id="destino_tipo" value="">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="num_op">Nº OP</label>
                            <input type="text" class="form-control" id="num_op" name="num_op">
                        </div>
                    </div>
                </div>

                <!-- Campo de Observaciones -->
                <div class="form-group">
                    <label for="observaciones">Observaciones</label>
                    <textarea class="form-control" id="observaciones" name="observaciones" rows="6" placeholder="Ingrese sus observaciones aquí"></textarea>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn custom-button">ENVIAR FORMULARIO</button>
                </div>
            </form>
        </div>
    </main>
    
    <!-- Contenedores ocultos con las opciones para cada caso -->
    <div id="opciones_setas" style="display: none;">
      <option value="">Seleccionar destino de setas...</option>
      {% for destino_s in destinos_setas %}
        <option value="{{ destino_s[0] }}">{{ destino_s[1] }}</option>
      {% endfor %}
    </div>
    
    <div id="opciones_champis" style="display: none;">
      <option value="">Seleccionar destino de champiñones...</option>
      {% for destino_c in destinos_champis %}
        <option value="{{ destino_c[0] }}">{{ destino_c[1] }}</option>
      {% endfor %}
    </div>
    
    <!-- Include jQuery antes de Select2 -->
    <script src="/static/js/jquery-3.5.1.min.js"></script>
    <script src="/static/js/select2.min.js"></script>
    <!-- Definición global de las funciones de formateo -->
    <script>
        function formatKilos(input) {
            // Permitir solo dígitos y coma
            let value = input.value.replace(/[^0-9,]/g, '');
            let parts = value.split(',');
            if (parts.length > 1) {
                value = parts[0] + ',' + parts[1].replace(/,/g, '');
            }
            // Eliminar puntos y cambiar coma por punto para conversión numérica
            let rawValue = value.replace(/\./g, '').replace(',', '.');
            let number = parseFloat(rawValue);
            if (!isNaN(number)) {
                let decimalDigits = (value.indexOf(',') !== -1) ? parts[1].length : 0;
                let formatted = number.toLocaleString('es-ES', {
                    minimumFractionDigits: decimalDigits,
                    maximumFractionDigits: decimalDigits
                });
                input.value = formatted;
            }
        }

        function formatPaquetes(input) {
            // Eliminar cualquier caracter que no sea dígito
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            let number = parseInt(value, 10);
            let formatted = number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            input.value = formatted;
        }

        // Exponer las funciones globalmente para que sean accesibles desde los atributos inline
        window.formatKilos = formatKilos;
        window.formatPaquetes = formatPaquetes;

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar select2 para el campo Código CINA
            $('#codigo_cina').select2({
                placeholder: 'Seleccionar...',
                width: '100%',
                dropdownAutoWidth: true,
                dropdownCssClass: 'custom-dropdown'
            });
            
            // Al cambiar el código CINA, solicitar la planta destino vía AJAX
            $('#codigo_cina').on('change', function() {
                var codigoCina = $(this).val();
                console.log("Código CINA seleccionado:", codigoCina);
                
                if (codigoCina) {
                    $.ajax({
                        url: '/get_planta_destino',
                        method: 'POST',
                        data: { codigo_cina: codigoCina },
                        success: function(response) {
                            console.log("Respuesta del servidor:", response);
                            
                            if (response.planta_destino === 'PCHAMPI') {
                                var opciones = $('#opciones_champis').html();
                                $('#destino').html(opciones);
                                $('#destino_tipo').val('PCHAMPI');
                            } else if (response.planta_destino === 'PSETAS') {
                                var opciones = $('#opciones_setas').html();
                                $('#destino').html(opciones);
                                $('#destino_tipo').val('PSETAS');
                            } else {
                                $('#destino').html('<option value="">Seleccionar destino...</option>');
                                $('#destino_tipo').val('');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error en la solicitud AJAX:", error);
                        }
                    });
                } else {
                    $('#destino').html('<option value="">Seleccionar destino...</option>');
                    $('#destino_tipo').val('');
                }
            });
            
            // Deshabilitar el select de destino si se ingresa valor en los campos de producción
            $('#num_op').on('input', function(){
                var numOpVal = $('#num_op').val().trim();
                if (numOpVal !== "") {
                    $('#destino').prop('disabled', true);
                    $('#destino').val('');
                } else {
                    $('#destino').prop('disabled', false);
                }
            });
            
            // Antes de enviar el formulario, limpiar los formatos para obtener números puros
            document.querySelector("form").addEventListener("submit", function(e) {
                // Limpiar kg_entrada: quitar puntos y cambiar la coma por punto
                var kgEntradaInput = document.getElementById('kg_entrada');
                var cleanedKgEntrada = kgEntradaInput.value.replace(/\./g, '').replace(',', '.');
                kgEntradaInput.value = cleanedKgEntrada;

                // Limpiar kg_descuento: quitar puntos y cambiar la coma por punto
                var kgDescuentoInput = document.getElementById('kg_descuento');
                var cleanedKgDescuento = kgDescuentoInput.value.replace(/\./g, '').replace(',', '.');
                kgDescuentoInput.value = cleanedKgDescuento;

                // Limpiar n_paquetes: quitar puntos para obtener el número entero
                var nPaquetesInput = document.getElementById('n_paquetes');
                var cleanedNPaquetes = nPaquetesInput.value.replace(/\./g, '');
                nPaquetesInput.value = cleanedNPaquetes;
            });
            
            // Manejo del flash overlay (mostrar y ocultar)
            const flashOverlay = document.querySelector('.flash-overlay');
            if (flashOverlay) {
                flashOverlay.classList.add('show');
                setTimeout(function() {
                    flashOverlay.classList.add('hide');
                }, 3000);
                setTimeout(function() {
                    flashOverlay.style.display = 'none';
                }, 3500);
            }
        });
    </script>
        
    <footer class="py-3">
        <p></p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>